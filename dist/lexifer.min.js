/* Lexifer TS v1.1.1+2 */
"use strict";class WeightedSelector{constructor(t){this.keys=[],this.t=[];for(let e in t){let i=t[e];"number"==typeof i&&(this.keys.push(e),this.t.push(i))}this.i=this.t.reduce((t,e)=>t+e,0)}select(){let t=Math.random()*this.i,e=0;for(let i=0;i<this.keys.length;++i)if(e+=this.t[i],t<e)return this.keys[i];throw new Error(`failed to choose options from '${this.keys.join("', '")}'.`)}}const main=(t,e,i=!1,s,r=!1,o=console.error)=>{let n="";try{let h=new PhonologyDefinition(t,o);"number"==typeof e?e<0?(o(`Cannot generate ${e} words.`),n=h.o()):(i&&(!1===s&&(o("** 'Unsorted' option always enabled in verbose mode."),s=!0),r&&o("** 'One per line' option ignored in verbose mode.")),n=wrap(h.h(e,i,s,r))):(i&&o("** 'Verbose' option ignored in paragraph mode."),s&&o("** 'Unsorted' option ignored in paragraph mode."),r&&o("** 'One per line' option ignored in paragraph mode."),n=h.o())}catch(t){o(t)}return n},genWords=()=>{document.getElementById("errors").innerHTML="",document.getElementById("result").innerHTML=main(document.getElementById("def").value,parseInt(document.getElementById("number").value)||void 0,document.getElementById("verbose").checked,document.getElementById("unsorted").checked,document.getElementById("one-per-line").checked,t=>{document.getElementById("errors").innerHTML+=t+"<br />"}).replace(/\n/gu,"<br />")};function last(t){var e=null==t?0:t.length;return e?t[e-1]:void 0}class PhonologyDefinition{constructor(t,e){if(this.l=e,this.u=[],this.p=[],this.g=[],this.m=[],this.$=0,this.v=new SoundSystem,""===t.trim())throw new Error("Please include a definition.");this.W=t.split("\n"),this.parse(),this.k()}parse(){for(;this.$<this.W.length;++this.$){let t=this.W[this.$];if(t=t.replace(/#.*/u,"").trim(),""!==t)if(t.startsWith("with:"))this.C(t.substring(5).trim());else if(t.startsWith("random-rate:")){let e=+t.substring(12);if(!(e>=0&&e<=100))throw new Error("Invalid random-rate.");this.v.S=e}else if(t.startsWith("filter:"))this.M(t.substring(7).trim());else if(t.startsWith("reject:"))this.A(t.substring(7).trim());else if(t.startsWith("words:"))this.R(t.substring(6).trim());else if(t.startsWith("letters:"))this.j(t.substring(8).trim());else if(t.startsWith("categories:"))this.O(t.substring(11).trim());else if("%"===t[0])this.q();else{if(!t.includes("="))throw new Error(`parsing error at '${t}'.`);this.I(t)}}!this.v.P&&!this.v.J||this.v.T||this.l("Without 'letters:' cannot apply assimilations or coronal metathesis.")}k(){if(this.p.length){let t=new Set(this.p),e=new Set(this.g);if(e.size>t.size){let i=[...e].filter(e=>!t.has(e)&&!t.has(e.split(":")[0]));this.l(`A phoneme class contains '${i.join(" ")}' missing from 'letters'.  Strange word shapes are likely to result.`)}}}C(t){for(let e of t.split(/\s+/gu))switch(e){case"std-ipa-features":this.v.F();break;case"std-digraph-features":this.v._();break;case"std-assimilations":this.v.P=!0;break;case"coronal-metathesis":this.v.J=!0;break;default:throw new Error(`unknown option '${e}'.`)}}M(t){for(let e of t.split(";")){if(e=e.trim(),""===e)continue;let t=e.split(">");if(2!==t.length)throw new Error(`malformed filter '${e}': filters must look like 'old > new'.`);let i=t[0].trim(),s=t[1].trim();this.v.addFilter(i,s)}}A(t){for(let e of t.split(/\s+/gu))this.v.addFilter(e,"REJECT")}R(t){if(this.m.length>0&&"words:"!==this.m[0])throw new Error("both 'words:' and 'categories:' found. Please only use one.");0===this.m.length&&this.v.D("words:",1),this.m=["words:"],this.U(t)}U(t,e){let i=t.split(/\s+/gu),s=t.includes(":");t.includes("??")&&this.l("'??' is treated as '?'."),("?"===t[0]||t.match(/\s\?[^?!]/u))&&this.l("'?' at the beginning of a rule does nothing.");for(let t=0;t<i.length;++t){let r,o;if(s){if(invalidItemAndWeight(i[t]))throw new Error(`'${i[t]}' is not a valid pattern and weight.`);let e;[r,e]=i[t].split(":"),o=+e}else r=i[t],o=10/Math.pow(t+1,.9);if(!r.match(/[^?!]/u))throw new Error(`'${i[t]}'`+(e?` (in category ${e})`:"")+" will only produce empty words.");r.match(/^\?*[^?!]!?\?+!?$/u)&&this.l(`'${i[t]}'`+(e?` (in category ${e})`:"")+" may produce empty words."),r=this.N(r),this.v.addRule(r,o,e)}}N(t){for(let[e,i]of this.u)t=t.replace(e,i);return t}j(t){this.p=t.split(/\s+/gu),this.v.V(t)}q(){var t;let e=this.W[this.$].split(/\s+/gu);e.shift();let i=e.length;for(;!["","\n",void 0].includes(this.W[this.$]);){let s=null!==(t=this.W[++this.$])&&void 0!==t?t:"";if(s=s.replace(/#.*/,"").trim(),""===s)continue;let r=s.split(/\s+/gu),o=r.splice(0,1);if(r.length!==i)throw r.length>i?new Error(`cluster field row too long: '${s}'.`):new Error(`cluster field row too short: '${s}'.`);for(let t=0;t<i;++t)"+"!==r[t]&&("-"===r[t]?this.v.addFilter(o+e[t],"REJECT"):this.v.addFilter(o+e[t],r[t]))}}I(t){let[e,i]=t.split("=");if(e=e.trim(),i=i.trim(),"$"===e[0])this.u.push([new RegExp(`\\${e}`,"gu"),i]);else if(1===e.length)this.g=this.g.concat(i.split(/\s+/gu)),this.v.L(e,i);else{if(!this.m.includes(e))throw new Error(`unknown category '${e}'. Please put category definitions after the 'categories:' statement.`);this.U(i,e)}}O(t){if(this.m.includes("words:"))throw new Error("both 'words:' and 'categories:' found. Please only use one.");let e=t.split(/\s+/gu),i=t.includes(":");for(let t of e)if(i){if(invalidItemAndWeight(t))throw new Error(`'${t}' is not a valid category and weight.`);let[e,i]=t.split(":"),s=+i;this.m.push(e),this.v.D(e,s)}else this.m.push(t),this.v.D(t,1)}h(t=1,e=!1,i=e,s=!1){let r="",o=[];for(let n of this.m)o=this.v.h(t,e,i,n),o.length<t&&this.l(`Could only generate ${o.length} word`+(1===o.length?"":"s")+" "+("words:"===n?"":`of category '${n}' `)+`(${t} requested).`),"words:"!==n&&(r+=`\n\n${n}:\n`),r+=o.join(s||e?"\n":" ");return r.trim()}o(t){return textify(this.v,t)}}const data=[["p","p",0,0,0],["b","b",1,0,0],["ɸ","ph",0,0,1],["β","bh",1,0,1],["f","f",0,1,1],["v","v",1,1,1],["m","m",1,0,2],["m","m",1,1,2],["t","t",0,2,0],["d","d",1,2,0],["s","s",0,2,3],["z","z",1,2,3],["θ","th",0,2,1],["ð","dh",1,2,1],["ɬ","lh",0,2,4],["ɮ","ldh",1,2,4],["tɬ","tl",0,2,5],["dɮ","dl",1,2,5],["ts","ts",0,2,6],["dz","dz",1,2,6],["ʃ","sh",0,3,3],["ʒ","zh",1,3,3],["tʃ","ch",0,3,6],["dʒ","j",1,3,6],["n","n",1,2,2],["ʈ","rt",0,4,0],["ɖ","rd",1,4,0],["ʂ","sr",0,4,3],["ʐ","zr",1,4,3],["ʈʂ","rts",0,4,6],["ɖʐ","rdz",1,4,6],["ɳ","rn",1,4,2],["c","ky",0,5,0],["ɟ","gy",1,5,0],["ɕ","sy",0,5,3],["ʑ","zy",1,5,3],["ç","hy",0,5,1],["ʝ","yy",1,5,1],["tɕ","cy",0,5,6],["dʑ","jy",1,5,6],["ɲ","ny",1,5,2],["k","k",0,6,0],["g","g",1,6,0],["x","kh",0,6,1],["ɣ","gh",1,6,1],["ŋ","ng",1,6,2],["q","q",0,7,0],["ɢ","gq",1,7,0],["χ","qh",0,7,1],["ʁ","gqh",1,7,1],["ɴ","nq",1,7,2]];let phdb=[];const initialize=(t=!0)=>{if(t)for(let t of data)phdb.push([t[0],t[2],t[3],t[4]]);else for(let t of data)phdb.push([t[1],t[2],t[3],t[4]])},applyAssimilations=t=>{const e=(t,e)=>{let i=phdb.find(e=>e[0]===t);if(i&&2===i[3]){let t=phdb.find(t=>t[0]===e);if(t){let e=phdb.find(e=>e[2]===t[2]&&2===e[3]);if(e)return e[0]}}return t},i=(t,e)=>{let i=phdb.find(t=>t[0]===e);if(i&&2!==i[3]){let e=phdb.find(e=>e[0]===t);if(e){let t=phdb.find(t=>t[1]===i[1]&&t[2]===e[2]&&t[3]===e[3]);if(t)return t[0]}}return t};let s=[...t];for(let r=0;r<t.length-1;++r)s[r]=i(t[r],t[r+1]),s[r]=e(s[r],t[r+1]);return s},applyCoronalMetathesis=t=>{const e=(t,e)=>{let i=phdb.filter(e=>e[0]===t)[0];if(i&&2===i[2]){let s=phdb.filter(t=>t[0]===e)[0];if(s&&[6,0].includes(s[2])&&[0,2].includes(s[3])&&s[3]===i[3])return[e,t]}return[t,e]};let i=[...t];for(let s=0;s<t.length-1;++s)[i[s],i[s+1]]=e(t[s],t[s+1]);return i},wrap=t=>t.replace(/(?![^\n]{1,70}$)([^\n]{1,70})\s/gu,"$1\n");class Word{constructor(t,e){this.forms=[t],this.filters=[e]}B(t,e){let i=last(this.forms);i=i.replace(new RegExp(t,"gu"),e),i.includes("REJECT")&&(i="REJECT"),i!==last(this.forms)&&(this.forms.push(i),this.filters.push(`${t} > ${e||"!"}`))}G(t){for(let e of t)if(this.B(...e),"REJECT"===last(this.forms))return}H(){if(Word.T){let t=applyAssimilations(Word.T.split(last(this.forms))).join("");t!==last(this.forms)&&(this.forms.push(t),this.filters.push("std-assimilations"))}}K(){if(Word.T){let t=applyCoronalMetathesis(Word.T.split(last(this.forms))).join("");t!==last(this.forms)&&(this.forms.push(t),this.filters.push("coronal-metathesis"))}}toString(){if(Word.X){let t="";for(let e in this.forms)t+=`${this.filters[e]} – ${this.forms[e]}\n`;return t}return last(this.forms)}}Word.X=!1,Word.T=null;const invalidItemAndWeight=t=>{let e=t.split(":");if(2!==e.length)return!0;let i=+e[1];return isNaN(i)||i<0||i===1/0};class ArbSorter{constructor(t){let e=t.split(/\s+/gu),i=[...e].sort((t,e)=>e.length-t.length);this.Y=new RegExp(`(${i.join("|")}|.)`,"gu"),this.Z={},this.tt=[];for(let t in e)this.Z[e[t]]=+t,this.tt.push(e[t])}et(t){let e=this.split(t).map(t=>this.Z[t]);if(e.includes(void 0))throw new Error(`word with unknown letter: '${t}'.\nA filter or assimilation might have caused this.`);return e}it(t){return t.map(t=>this.tt[t]).join("")}split(t){return t.split(this.Y).filter((t,e)=>e%2)}sort(t){let e=t.filter(t=>""!==t).map(t=>this.et(t));return e.sort((t,e)=>t[0]-e[0]),e.map(t=>this.it(t))}}const _weight=Symbol();class SoundSystem{constructor(){this.st={},this.filters=[],this.S=10,this.P=!1,this.J=!1,this.rt={},this.T=null}ot(t){let e=t.length,i=[];if("!"===t[0]||"!"===t[1]||t.includes("!!"))throw new Error(`misplaced '!' option: in non-duplicate environment: '${t}'.`);for(let s=0;s<e;++s)if(!"?!".includes(t[s]))if(s<e-1&&"?"===t[s+1])100*Math.random()<this.S&&(t[s]in this.st?i.push(this.st[t[s]].select()):i.push(t[s]));else if(s<e-1&&s>0&&"!"===t[s+1]){let e;if(e="?"===t[s-1]&&s>2?t[s-2]:t[s-1],t[s]!==e)throw new Error(`misplaced '!' option: in non-duplicate environment: '${t}'.`);if(t[s]in this.st){let e;do{e=this.st[t[s]].select()}while(e===last(i));i.push(e)}}else t[s]in this.st?i.push(this.st[t[s]].select()):i.push(t[s]);return i.join("")}G(t){return this.P&&t.H(),this.J&&t.K(),t.G(this.filters),t}L(t,e){e.includes(":")||(e=(t=>{const e=(t,e=10)=>t+t*e/100*(Math.random()-.5);let i=t.split(/\s+/gu),s={},r=i.length;for(let t=0;t<r;++t)s[i[t]]=e((Math.log(r+1)-Math.log(t+1))/r);let o="";for(let t in s)o+=`${t}:${s[t]} `;return o.trim(),o})(e)),this.st[t]=new WeightedSelector((t=>{let e=t.trim().split(/\s+/gu),i={};for(let t of e){if(invalidItemAndWeight(t))throw new Error(`'${t}' is not a valid phoneme and weight.`);let[e,s]=t.split(":");i[e]=+s}return i})(e))}addRule(t,e,i="words:"){if(!this.rt[i])throw new Error(`uninitialized category '${i}' referenced.`);this.rt[i][t]=e}D(t,e){this.rt[t]={[_weight]:e}}addFilter(t,e){"!"===e?this.filters.push([t,""]):this.filters.push([t,e])}V(t){this.T=new ArbSorter(t)}F(){initialize()}_(){initialize(!1)}h(t,e,i,s,r=!1){let o,n=new Set;if(Word.X=e,Word.T=this.T,!this.rt[s])throw new Error(`unknown category '${s}'.`);let h=Object.assign(Object.assign({},this.rt[s]),{[_weight]:void 0});1===Object.keys(h).length&&(h=Object.assign({[s]:0},h)),o=new WeightedSelector(h);for(let e=0;r||e<3*t;++e){let e=o.select(),i=this.ot(e),s=new Word(i,e);if(this.G(s),"REJECT"!==s.toString()&&(n.add(s.toString()),n.size===t))break}let l=Array.from(n);return i||e||(this.T?l=this.T.sort(l):l.sort()),l}nt(){let t={};for(let e in this.rt)t[e]=this.rt[e][_weight];return new WeightedSelector(t).select()}}const textify=(t,e=25)=>{let i="";for(let s=0;s<e;++s){let e=Math.floor(9*Math.random())+3,s=-1;e>=7&&(s=Math.floor(Math.random()*(e-1))),i+=t.h(1,!1,!0,t.nt(),!0)[0].toString().replace(/./u,t=>t.toUpperCase());for(let r=0;r<e;++r)i+=` ${t.h(1,!1,!0,t.nt(),!0)[0]}`,r===s&&(i+=",");Math.random()<=.85?i+=". ":i+="? "}return wrap(i.trim())};