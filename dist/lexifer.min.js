/* Lexifer TS v1.1.1 */
"use strict";class WeightedSelector{constructor(e){this.keys=[],this.weights=[];for(let t in e){let s=e[t];"number"==typeof s&&(this.keys.push(t),this.weights.push(s))}this.sum=this.weights.reduce((e,t)=>e+t,0)}select(){let e=Math.random()*this.sum,t=0;for(let s=0;s<this.keys.length;++s)if(e<(t+=this.weights[s]))return this.keys[s];throw new Error("failed to choose options from "+`'${this.keys.join("', '")}'.`)}}const main=(e,t,s=!1,r,i=!1,o=console.error)=>{let n="";try{let l=new PhonologyDefinition(e,o);"number"==typeof t?t<0?(o(`Cannot generate ${t} words.`),n=l.paragraph()):(s&&(!1===r&&(o("** 'Unsorted' option always enabled in verbose mode."),r=!0),i&&o("** 'One per line' option ignored in verbose mode.")),n=wrap(l.generate(t,s,r,i))):(s&&o("** 'Verbose' option ignored in paragraph mode."),r&&o("** 'Unsorted' option ignored in paragraph mode."),i&&o("** 'One per line' option ignored in paragraph mode."),n=l.paragraph())}catch(e){o(e)}return n},genWords=()=>{document.getElementById("errors").innerHTML="",document.getElementById("result").innerHTML=main(document.getElementById("def").value,parseInt(document.getElementById("number").value)||void 0,document.getElementById("verbose").checked,document.getElementById("unsorted").checked,document.getElementById("one-per-line").checked,function(e){document.getElementById("errors").innerHTML+=e+"<br />"}).replace(/\n/gu,"<br />")};function last(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}class PhonologyDefinition{constructor(e,t){if(this.stderr=t,this.macros=[],this.letters=[],this.phClasses=[],this.categories=[],this.defFileLineNum=0,this.soundsys=new SoundSystem,""===e.trim())throw new Error("Please include a definition.");this.defFileArr=e.split("\n"),this.parse(),this.sanityCheck()}parse(){for(;this.defFileLineNum<this.defFileArr.length;++this.defFileLineNum){let e=this.defFileArr[this.defFileLineNum];if(""!==(e=e.replace(/#.*/u,"").trim()))if(e.startsWith("with:"))this.parseOption(e.substring(5).trim());else if(e.startsWith("random-rate:"))this.soundsys.randpercent=parseInt(e.substring(12));else if(e.startsWith("filter:"))this.parseFilter(e.substring(7).trim());else if(e.startsWith("reject:"))this.parseReject(e.substring(7).trim());else if(e.startsWith("words:"))this.parseWords(e.substring(6).trim());else if(e.startsWith("letters:"))this.parseLetters(e.substring(8).trim());else if(e.startsWith("categories:"))this.parseCategories(e.substring(11).trim());else if("%"===e[0])this.parseClusterfield();else{if(!e.includes("="))throw new Error(`parsing error at '${e}'.`);this.parseClass(e)}}!this.soundsys.useAssim&&!this.soundsys.useCoronalMetathesis||this.soundsys.sorter||this.stderr("Without 'letters:' cannot apply assimilations or coronal metathesis.")}sanityCheck(){if(this.letters.length){let e=new Set(this.letters),t=new Set(this.phClasses);if(t.size>e.size){let s=[...t].filter(t=>!e.has(t));this.stderr(`A phoneme class contains '${s.join(" ")}' `+"missing from 'letters'.  Strange word shapes are likely to result.")}}}parseOption(e){for(let t of e.split(/\s+/gu))switch(t){case"std-ipa-features":this.soundsys.useIpa();break;case"std-digraph-features":this.soundsys.useDigraphs();break;case"std-assimilations":this.soundsys.useAssim=!0;break;case"coronal-metathesis":this.soundsys.useCoronalMetathesis=!0;break;default:throw new Error(`unknown option '${t}'.`)}}parseFilter(e){for(let t of e.split(";")){if(""===(t=t.trim()))continue;let e=t.split(">");if(2!==e.length)throw new Error(`malformed filter '${t}': filters must look`+" like 'old > new'.");let s=e[0].trim(),r=e[1].trim();this.soundsys.addFilter(s,r)}}parseReject(e){for(let t of e.split(/\s+/gu))this.soundsys.addFilter(t,"REJECT")}parseWords(e){if(this.categories.length>0&&"words:"!==this.categories[0])throw new Error("both 'words:' and 'categories:' found. Please only use one.");0===this.categories.length&&this.soundsys.addCategory("words:",1),this.categories=["words:"],this.addRules(e)}addRules(e,t){let s=e.split(/\s+/gu),r=e.includes(":");for(let e=0;e<s.length;++e){let i,o;if(r){if(invalidItemAndWeight(s[e]))throw new Error(`'${s[e]}' is not a valid pattern and `+"weight.");let t;[i,t]=s[e].split(":"),o=+t}else i=s[e],o=10/Math.pow(e+1,.9);if(!i.match(/[^?!]/u))throw new Error(`'${s[e]}' `+(t?`(in category ${t}) `:"")+"will only produce empty words.");i.includes("??")&&this.stderr("'??' is treated as '?'."),i=this.expandMacros(i),this.soundsys.addRule(i,o,t)}}expandMacros(e){for(let[t,s]of this.macros)e=e.replace(t,s);return e}parseLetters(e){this.letters=e.split(/\s+/gu),this.soundsys.addSortOrder(e)}parseClusterfield(){var e;let t=this.defFileArr[this.defFileLineNum].split(/\s+/gu);t.shift();let s=t.length;for(;!["","\n",void 0].includes(this.defFileArr[this.defFileLineNum]);){let r=null!==(e=this.defFileArr[++this.defFileLineNum])&&void 0!==e?e:"";if(""===(r=r.replace(/#.*/,"").trim()))continue;let i=r.split(/\s+/gu),o=i.splice(0,1);if(i.length!==s)throw i.length>s?new Error(`cluster field row too long: '${r}'.`):new Error(`cluster field row too short: '${r}'.`);for(let e=0;e<s;++e)"+"!==i[e]&&("-"===i[e]?this.soundsys.addFilter(o+t[e],"REJECT"):this.soundsys.addFilter(o+t[e],i[e]))}}parseClass(e){let[t,s]=e.split("=");if(t=t.trim(),s=s.trim(),"$"===t[0])this.macros.push([new RegExp(`\\${t}`,"gu"),s]);else if(1===t.length)this.phClasses=this.phClasses.concat(s.split(/\s+/gu)),this.soundsys.addPhUnit(t,s);else{if(!this.categories.includes(t))throw new Error(`unknown category '${t}'. Please put category`+" definitions after the 'categories:' statement.");this.addRules(s,t)}}parseCategories(e){if(this.categories.includes("words:"))throw new Error("both 'words:' and 'categories:' found. Please only use one.");let t=e.split(/\s+/gu),s=e.includes(":");for(let e of t)if(s){if(invalidItemAndWeight(e))throw new Error(`'${e}' is not a valid category and `+"weight.");let[t,s]=e.split(":"),r=+s;this.categories.push(t),this.soundsys.addCategory(t,r)}else this.categories.push(e),this.soundsys.addCategory(e,1)}generate(e=1,t=!1,s=t,r=!1){let i="",o=[];for(let n of this.categories)(o=this.soundsys.generate(e,t,s,n)).length<e&&this.stderr(`Could only generate ${o.length} word`+`${1===o.length?"":"s"} `+("words:"===n?"":`of category '${n}' `)+`(${e} requested).`),"words:"!==n&&(i+=`\n\n${n}:\n`),i+=o.join(r||t?"\n":" ");return i.trim()}paragraph(e){return textify(this.soundsys,e)}}const data=[["p","p",0,0,0],["b","b",1,0,0],["ɸ","ph",0,0,1],["β","bh",1,0,1],["f","f",0,1,1],["v","v",1,1,1],["m","m",1,0,2],["m","m",1,1,2],["t","t",0,2,0],["d","d",1,2,0],["s","s",0,2,3],["z","z",1,2,3],["θ","th",0,2,1],["ð","dh",1,2,1],["ɬ","lh",0,2,4],["ɮ","ldh",1,2,4],["tɬ","tl",0,2,5],["dɮ","dl",1,2,5],["ts","ts",0,2,6],["dz","dz",1,2,6],["ʃ","sh",0,3,3],["ʒ","zh",1,3,3],["tʃ","ch",0,3,6],["dʒ","j",1,3,6],["n","n",1,2,2],["ʈ","rt",0,4,0],["ɖ","rd",1,4,0],["ʂ","sr",0,4,3],["ʐ","zr",1,4,3],["ʈʂ","rts",0,4,6],["ɖʐ","rdz",1,4,6],["ɳ","rn",1,4,2],["c","ky",0,5,0],["ɟ","gy",1,5,0],["ɕ","sy",0,5,3],["ʑ","zy",1,5,3],["ç","hy",0,5,1],["ʝ","yy",1,5,1],["tɕ","cy",0,5,6],["dʑ","jy",1,5,6],["ɲ","ny",1,5,2],["k","k",0,6,0],["g","g",1,6,0],["x","kh",0,6,1],["ɣ","gh",1,6,1],["ŋ","ng",1,6,2],["q","q",0,7,0],["ɢ","gq",1,7,0],["χ","qh",0,7,1],["ʁ","gqh",1,7,1],["ɴ","nq",1,7,2]];let phdb=[];const initialize=(e=!0)=>{if(e)for(let e of data)phdb.push([e[0],e[2],e[3],e[4]]);else for(let e of data)phdb.push([e[1],e[2],e[3],e[4]])},applyAssimilations=e=>{const t=(e,t)=>{let s=phdb.find(t=>t[0]===e);if(s&&2===s[3]){let e=phdb.find(e=>e[0]===t);if(e){let t=phdb.find(t=>t[2]===e[2]&&2===t[3]);if(t)return t[0]}}return e},s=(e,t)=>{let s=phdb.find(e=>e[0]===t);if(s&&2!==s[3]){let t=phdb.find(t=>t[0]===e);if(t){let e=phdb.find(e=>e[1]===s[1]&&e[2]===t[2]&&e[3]===t[3]);if(e)return e[0]}}return e};let r=[...e];for(let i=0;i<e.length-1;++i)r[i]=s(e[i],e[i+1]),r[i]=t(r[i],e[i+1]);return r},applyCoronalMetathesis=e=>{const t=(e,t)=>{let s=phdb.filter(t=>t[0]===e)[0];if(s&&2===s[2]){let r=phdb.filter(e=>e[0]===t)[0];if(r&&[6,0].includes(r[2])&&[0,2].includes(r[3])&&r[3]===s[3])return[t,e]}return[e,t]};let s=[...e];for(let r=0;r<e.length-1;++r)[s[r],s[r+1]]=t(e[r],e[r+1]);return s},wrap=e=>e.replace(/(?![^\n]{1,70}$)([^\n]{1,70})\s/gu,"$1\n");class Word{constructor(e,t){this.forms=[e],this.filters=[t]}applyFilter(e,t){let s=last(this.forms);(s=s.replace(new RegExp(e,"gu"),t)).includes("REJECT")&&(s="REJECT"),s!==last(this.forms)&&(this.forms.push(s),this.filters.push(`${e} > ${t||"!"}`))}applyFilters(e){for(let t of e)if(this.applyFilter(...t),"REJECT"===last(this.forms))return}applyAssimilations(){if(Word.sorter){let e=applyAssimilations(Word.sorter.split(last(this.forms))).join("");e!==last(this.forms)&&(this.forms.push(e),this.filters.push("std-assimilations"))}}applyCoronalMetathesis(){if(Word.sorter){let e=applyCoronalMetathesis(Word.sorter.split(last(this.forms))).join("");e!==last(this.forms)&&(this.forms.push(e),this.filters.push("coronal-metathesis"))}}toString(){if(Word.verbose){let e="";for(let t in this.forms)e+=`${this.filters[t]} – ${this.forms[t]}\n`;return e}return last(this.forms)}}Word.verbose=!1,Word.sorter=null;const invalidItemAndWeight=e=>{let t=e.split(":");if(2!==t.length)return!0;let s=+t[1];return isNaN(s)||s<0||s===1/0};class ArbSorter{constructor(e){let t=e.split(/\s+/gu),s=[...t].sort((e,t)=>t.length-e.length);this.splitter=new RegExp(`(${s.join("|")}|.)`,"gu"),this.ords={},this.vals=[];for(let e in t)this.ords[t[e]]=+e,this.vals.push(t[e])}wordAsValues(e){let t=this.split(e).map(e=>this.ords[e]);if(t.includes(void 0))throw new Error(`word with unknown letter: '${e}'.\n`+"A filter or assimilation might have caused this.");return t}valuesAsWord(e){return e.map(e=>this.vals[e]).join("")}split(e){return e.split(this.splitter).filter((e,t)=>t%2)}sort(e){let t=e.filter(e=>""!==e).map(e=>this.wordAsValues(e));return t.sort((e,t)=>e[0]-t[0]),t.map(e=>this.valuesAsWord(e))}}class SoundSystem{constructor(){this.phonemeset={},this.filters=[],this.randpercent=10,this.useAssim=!1,this.useCoronalMetathesis=!1,this.ruleset={},this.sorter=null}runRule(e){let t=e.length,s=[];if("!"===e[1]||e.includes("!!"))throw new Error("misplaced '!' option: in non-duplicate "+`environment: '${e}'.`);for(let r=0;r<t;++r)if(!"?!".includes(e[r]))if(r<t-1&&"?"===e[r+1])100*Math.random()<this.randpercent&&(e[r]in this.phonemeset?s.push(this.phonemeset[e[r]].select()):s.push(e[r]));else if(r<t-1&&r>0&&"!"===e[r+1]){let t;if(t="?"===e[r-1]&&r>2?e[r-2]:e[r-1],e[r]!==t)throw new Error("misplaced '!' option: in non-duplicate"+` environment: '${e}'.`);if(e[r]in this.phonemeset){let t;do{t=this.phonemeset[e[r]].select()}while(t===last(s));s.push(t)}}else e[r]in this.phonemeset?s.push(this.phonemeset[e[r]].select()):s.push(e[r]);return s.join("")}applyFilters(e){return this.useAssim&&e.applyAssimilations(),this.useCoronalMetathesis&&e.applyCoronalMetathesis(),e.applyFilters(this.filters),e}addPhUnit(e,t){t.includes(":")||(t=(e=>{const t=(e,t=10)=>e+e*t/100*(Math.random()-.5);let s=e.split(/\s+/gu),r={},i=s.length;for(let e=0;e<i;++e)r[s[e]]=t((Math.log(i+1)-Math.log(e+1))/i);let o="";for(let e in r)o+=`${e}:${r[e]} `;return o.trim(),o})(t)),this.phonemeset[e]=new WeightedSelector((e=>{let t=e.trim().split(/\s+/gu),s={};for(let e of t){if(invalidItemAndWeight(e))throw new Error(`'${e}' is not a valid phoneme and `+"weight.");let[t,r]=e.split(":");s[t]=+r}return s})(t))}addRule(e,t,s="words:"){if(!this.ruleset[s])throw new Error(`uninitialized category '${s}' referenced.`);this.ruleset[s][e]=t}addCategory(e,t){this.ruleset[e]={_weight:t}}addFilter(e,t){"!"===t?this.filters.push([e,""]):this.filters.push([e,t])}addSortOrder(e){this.sorter=new ArbSorter(e)}useIpa(){initialize()}useDigraphs(){initialize(!1)}generate(e,t,s,r,i=!1){let o,n=new Set;if(Word.verbose=t,Word.sorter=this.sorter,!this.ruleset[r])throw new Error(`unknown category '${r}'.`);let l=Object.assign(Object.assign({},this.ruleset[r]),{_weight:void 0});1===Object.keys(l).length&&(l=Object.assign({[r]:0},l)),o=new WeightedSelector(l);for(let t=0;i||t<3*e;++t){let t=o.select(),s=this.runRule(t),r=new Word(s,t);if(this.applyFilters(r),"REJECT"!==r.toString()&&(n.add(r.toString()),n.size===e))break}let h=Array.from(n);return s||t||(this.sorter?h=this.sorter.sort(h):h.sort()),h}randomCategory(){let e={};for(let t in this.ruleset)e[t]=this.ruleset[t]._weight;return new WeightedSelector(e).select()}}const textify=(e,t=25)=>{let s="";for(let r=0;r<t;++r){let t=Math.floor(9*Math.random())+3,r=-1;t>=7&&(r=Math.floor(Math.random()*(t-1))),s+=e.generate(1,!1,!0,e.randomCategory(),!0)[0].toString().replace(/./u,e=>e.toUpperCase());for(let i=0;i<t;++i)s+=` ${e.generate(1,!1,!0,e.randomCategory(),!0)[0]}`,i===r&&(s+=",");Math.random()<=.85?s+=". ":s+="? "}return wrap(s.trim())};